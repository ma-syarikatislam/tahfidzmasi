<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Penilaian Tahfidz</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 600px;
      margin: auto;
      padding: 1rem;
    }
    h1 {
      text-align: center;
      font-size: 1.5rem;
    }
    label {
      margin-top: 1rem;
      display: block;
      font-weight: bold;
    }
    select, button {
      width: 100%;
      padding: 0.6rem;
      font-size: 1rem;
      margin-top: 0.5rem;
      margin-bottom: 1rem;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .surat-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
      border-bottom: 1px solid #ddd;
      padding: 0.5rem 0;
    }
    .radio-group {
      display: none;
      justify-content: space-between;
      margin-top: 0.5rem;
    }
    .hamburger {
      cursor: pointer;
      padding: 0.3rem 0.5rem;
      font-size: 1.5rem;
    }
    button {
      background-color: green;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Penilaian Tahfidz</h1>

  <label for="penguji">Nama Penguji</label>
  <select id="penguji"></select>

  <label for="kelas">Kelas</label>
  <select id="kelas"></select>

  <label for="siswa">Nama Siswa</label>
  <select id="siswa"></select>

  <div id="surat-list"></div>

  <button onclick="submitData()">Kirim</button>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwulUCkx_BBeCwcH6JmwPvGxxOf_2xTPlr2HUdE57ocA0H6pXdU9BFJ2OepG_MismuRnw/exec";
    const sheetCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQD2YcUVKH2yWyRmAwS99LD8C_epY2JFALaUs4z4yVt4Q0gQwOhsO7MWgVP0qE6tPQ_NqOBkFi2twyM/pub?output=csv";

    const pengujiSelect = document.getElementById('penguji');
    const kelasSelect = document.getElementById('kelas');
    const siswaSelect = document.getElementById('siswa');
    const suratList = document.getElementById('surat-list');

    let siswaData = [];
    let headerSurat = [];

    fetch(sheetCSV)
      .then(res => res.text())
      .then(text => {
        const rows = text.trim().split("\n").map(r => r.split(","));
        const header = rows[0];
        headerSurat = header.slice(2); // kolom C1 dan seterusnya

        const dataRows = rows.slice(1).filter(row => row[0] && row[1]); // pastikan kolom A & B terisi
        siswaData = dataRows.map(row => ({
          kelas: row[0].trim(),
          nama: row[1].trim()
        }));

        // Isi dropdown penguji
        const pengujiList = ["Iwang Wahyu, S.Pd.I", "Siti Aminah", "Ahmad F", "Nurul F"];
        pengujiList.forEach(name => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          pengujiSelect.appendChild(opt);
        });

        // Ambil kelas unik
        const kelasUnik = [...new Set(siswaData.map(s => s.kelas))];
        kelasUnik.forEach(kelas => {
          const opt = document.createElement('option');
          opt.value = kelas;
          opt.textContent = kelas;
          kelasSelect.appendChild(opt);
        });

        // Render list surat
        renderSuratList();
      });

    kelasSelect.addEventListener('change', () => {
      const selectedKelas = kelasSelect.value;
      siswaSelect.innerHTML = '';
      const siswaKelas = siswaData.filter(s => s.kelas === selectedKelas);
      siswaKelas.forEach(s => {
        const option = document.createElement('option');
        option.value = s.nama;
        option.textContent = s.nama;
        siswaSelect.appendChild(option);
      });
    });

    function renderSuratList() {
      suratList.innerHTML = '';
      headerSurat.forEach((surat, index) => {
        const div = document.createElement('div');
        div.className = 'surat-item';
        div.innerHTML = `
          <span>${surat}</span>
          <span class="hamburger" onclick="toggleRadio(${index})">&#9776;</span>
        `;
        const radios = document.createElement('div');
        radios.className = 'radio-group';
        radios.id = 'radio-' + index;
        radios.innerHTML = `
          <label><input type="radio" name="surat-${index}" value="M"> M</label>
          <label><input type="radio" name="surat-${index}" value="J"> J</label>
          <label><input type="radio" name="surat-${index}" value="FT"> FT</label>
        `;
        suratList.appendChild(div);
        suratList.appendChild(radios);
      });
    }

    function toggleRadio(index) {
      const radios = document.getElementById('radio-' + index);
      radios.style.display = radios.style.display === 'flex' ? 'none' : 'flex';
    }

    function submitData() {
      const penguji = pengujiSelect.value;
      const kelas = kelasSelect.value;
      const siswa = siswaSelect.value;

      const nilaiSurat = {};
      headerSurat.forEach((surat, index) => {
        const val = document.querySelector(`input[name="surat-${index}"]:checked`);
        if (val) {
          nilaiSurat[surat] = `${val.value} (${penguji})`;
        }
      });

      const data = {
        penguji,
        kelas,
        siswa,
        nilai: nilaiSurat
      };

      fetch(SCRIPT_URL, {
        method: "POST",
        body: JSON.stringify(data),
        headers: { "Content-Type": "application/json" }
      })
      .then(response => alert("Data berhasil dikirim!"))
      .catch(error => alert("Gagal mengirim: " + error.message));
    }
  </script>
</body>
</html>
